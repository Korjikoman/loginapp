{% extends 'app/base.html' %}
{% load crispy_forms_tags %}
{% block content %}
<h2>Upload file</h2>

<form method="post", enctype="multipart/form-data">
    {% csrf_token %}
    {{ AudioForm | crispy }}
    <div class="d-grid gap-3 mt-3">
        <button type="submit" class="btn btn-outline-success">Upload audio</button>
    </div>
</form>
    
<p>Your file size :</p>
{{ file.size|filesizeformat }}
{{ file.size }}
<h2>Transcript</h2>

{% if error %}
    <p id="error" style="color: red">{{ error }}</p>
{% endif %}
<p id="transcript">
    
    {{ text }}

</p>
<script>
    // WebSocket для реального времени
    const socket = new WebSocket('ws://' + window.location.host + '/ws/audio_transcription/');

    // При получении сообщения добавляем текст к транскрипции
    socket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        document.getElementById('transcription').innerText += data.message + "\n";
    };

    // Обработка формы загрузки файла
    document.getElementById('upload-form').onsubmit = function(event) {
        event.preventDefault();

        const formData = new FormData(this);
        fetch("{% url 'transcribe_audio' %}", {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        }).then(response => {
            if (response.ok) {
                console.log("Transcription started...");
            } else {
                console.error("Error uploading file.");
            }
        });
    };
</script>

<script>
    const errorEl = document.getElementById("error");
    const transcriptEl = document.getElementById("transcript");
    const fileUploadBtn = document.getElementById("upload-button");
    fileUploadBtn.addEventListener("click", updateTranscriptionText);
    async function updateTranscriptionText() {
    if (errorEl) {
    errorEl.remove();
    }
    transcriptEl.innerText = "Transcribing...";
    }
</script>
{% endblock %}